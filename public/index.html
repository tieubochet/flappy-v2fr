
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farcaster Flappy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://placehold.co/1200x630/png",
    "button":{"title":"Play","action":{
      "type":"launch_frame",
      "name":"Farcaster Flappy",
      "url":"https://flappy-v2fr.vercel.app",
      "splashImageUrl":"https://placehold.co/512/png",
      "splashBackgroundColor":"#000000"
    }}
  }'>
</head>
<body>
  <div id="container">
    <div id="game-wrapper">
      <canvas id="gameCanvas" width="424" height="695"></canvas>
      <button id="homeBtn" class="home-btn" style="display: none;">Home</button>
      <div id="start-screen" class="game-overlay">
        <h1>Farcaster Flappy</h1>
        <button id="playBtn">Play Game</button>
        <button id="signinBtn" class="secondary">Sign In with Farcaster</button>
        <button id="signoutBtn" class="secondary" style="display:none;">Sign Out</button>
        <p id="signedInFid" style="display:none; margin-top: 10px;"></p>
      </div>
      <div id="game-over-screen" class="game-overlay" style="display:none;">
        <h2>Game Over</h2>
        <div id="final-score">Score: 0</div>
        <button id="restartBtn">Restart</button>
      </div>
    </div>
    <div id="ui">
      <div id="leaderboard"></div>
    </div>
  </div>

<script type="module">
import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'
import { startGame } from './flappy.js';

await sdk.actions.ready();

let fid = null;
let currentGameInstance = null;

// UI Elements
const signinBtn = document.getElementById('signinBtn');
const signoutBtn = document.getElementById('signoutBtn');
const playBtn = document.getElementById('playBtn');
const restartBtn = document.getElementById('restartBtn');
const homeBtn = document.getElementById('homeBtn');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const finalScoreDisplay = document.getElementById('final-score');
const signedInFidDisplay = document.getElementById('signedInFid');
const leaderboardContainer = document.getElementById('leaderboard');

function updateLoginUI(isLoggedIn) {
  if (isLoggedIn) {
    signinBtn.style.display = 'none';
    signoutBtn.style.display = 'block';
    signedInFidDisplay.textContent = `Signed in as FID: ${fid}`;
    signedInFidDisplay.style.display = 'block';
  } else {
    signinBtn.style.display = 'block';
    signoutBtn.style.display = 'none';
    signedInFidDisplay.style.display = 'none';
  }
}

signinBtn.onclick = async () => {
  try {
    const { token } = await sdk.quickAuth.getToken();
    if (!token) {
      throw new Error("Authentication token could not be retrieved.");
    }
    
    // Decode the JWT to get the user's FID from the 'sub' claim.
    const payload = JSON.parse(atob(token.split('.')[1]));
    const userFid = payload.sub;

    if (userFid) {
      fid = userFid;
      localStorage.setItem('userFid', fid);
      updateLoginUI(true);
    } else {
      throw new Error("Could not determine FID from token.");
    }
  } catch (e) {
    if (e.name !== 'RejectedByUser') {
      alert('Sign in failed: ' + e.message);
    } else {
      console.log('User cancelled sign in');
    }
  }
};

signoutBtn.onclick = () => {
  localStorage.removeItem('userFid');
  fid = null;
  updateLoginUI(false);
};

homeBtn.onclick = () => {
  if (currentGameInstance) {
    currentGameInstance.stop();
    currentGameInstance = null;
  }
  startScreen.style.display = 'flex';
  gameOverScreen.style.display = 'none';
  homeBtn.style.display = 'none';
};

function checkLoginState() {
  const storedFid = localStorage.getItem('userFid');
  if (storedFid) {
    fid = parseInt(storedFid, 10);
    updateLoginUI(true);
  }
}

async function loadLeaderboard(){
  try {
    const res = await fetch('/api/leaderboard');
    const lb = await res.json();
    leaderboardContainer.innerHTML =
      '<h3>Leaderboard</h3>' +
      (lb.length > 0
        ? lb.map((e,i)=>`<div class="lb-row"><span>#${i+1} FID ${e.fid}</span> <strong>${e.score}</strong></div>`).join('')
        : '<div class="lb-row"><span>No scores yet!</span></div>'
      );
  } catch (e) {
    console.error('Failed to load leaderboard', e);
  }
}

function runGame() {
  currentGameInstance = startGame(
    // onGameOver callback
    async (finalScore) => {
      finalScoreDisplay.textContent = 'Score: ' + finalScore;
      gameOverScreen.style.display = 'flex';
      homeBtn.style.display = 'none';
      if (fid) {
        try {
          await fetch('/api/score', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ fid, score: finalScore })
          });
          await loadLeaderboard();
        } catch (e) {
          console.error('Failed to submit score', e);
        }
      }
    },
    // onScore callback (currently handled on canvas)
    (scoreNow) => {}
  );
}

playBtn.onclick = () => {
  startScreen.style.display = 'none';
  homeBtn.style.display = 'block';
  runGame();
};

restartBtn.onclick = () => {
  gameOverScreen.style.display = 'none';
  homeBtn.style.display = 'block';
  runGame();
};

// Initial Load
loadLeaderboard();
checkLoginState();
</script>
</body>
</html>
